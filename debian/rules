#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

#%:
#	dh $@

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/patchsys-quilt.mk
#include /usr/share/cdbs/1/class/maven.mk

DEST := $(CURDIR)/debian/kune
TARGET := $(CURDIR)/target
RESOURCES := $(CURDIR)/src/main/resources
WEBAPP := $(CURDIR)/src/main/webapp
TARGETC := $(TARGET)/kune-0.1.0-SNAPSHOT

KUNE := $(DEST)/usr/share/kune
ETCDIR := $(DEST)/etc/kune
LOGDIR := $(DEST)/var/log/kune
VARDIR := $(DEST)/var/lib/kune

NO_GWT=true

JAVA_HOME := /usr/lib/jvm/java-6-openjdk

build/kune::

#	mvn assembly:assembly -Dgwt.compiler.skip=$(NO_GWT)

binary-indep: build install/kune
binary-arch: binary-indep
binary: binary-indep

clean/kune::

	mvn clean:clean

install/kune::

#	dh_testdir
#	dh_clean -k
#	dh_installdirs
# FIXME make this via http://www.debian.org/doc/manuals/maint-guide/dother.en.html#conffiles
# FIXME user owner and perms of this
	cp $(CURDIR)/script/server.sh $(KUNE)/bin/
	cp $(TARGET)/kune-0.1.0-SNAPSHOT-complete.jar $(KUNE)/lib/kune-complete.jar
#FIXME this fails
	cp $(RESOURCES)/wave-server-production.properties $(ETCDIR)/wave-server.properties
	cp $(RESOURCES)/server.federation.config.example $(ETCDIR)
	cp $(RESOURCES)/jaas.config $(ETCDIR)
	cp $(RESOURCES)/mail-notif-template.html $(ETCDIR)
	cp $(CURDIR)/script/kune_initialize.sql $(DEST)/usr/share/dbconfig-common/data/kune/install/mysql
#	cp upgrade_0.6.0.sql $(DEST)/usr/share/dbconfig-common/data/confusa/upgrade/mysql/0.6.0.sql

# FIXME
#	cp logrotate $(DEST)/etc/logrotate.d/

# FIXME find another better way to do this (and remove rsync build dep)
# FIXME user owner and perms of this
	rsync -aC $(CURDIR)/src/main/webapp/* $(KUNE)/webapp
	rsync -aC $(TARGETC)/ws/* $(KUNE)/webclient/ws

	dh_installdebconf
	dh_installdeb


#get-orig-source:
#        sh -e debian/orig-tar.sh
